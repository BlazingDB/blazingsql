
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Program Listing for File executor.cpp &#8212; BlazingSQL v0.18 documentation</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.101715efdecc9b59cb6e1ddfa685c31f.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/collapsible-lists/css/tree_view.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/getting_started.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/blazingsql.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/pandas.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.d8bbf5861d671d414e1a.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/js/d3.v3.min.js"></script>
    <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
    <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    <link rel="shortcut icon" href="../_static/blazingsql-icon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">


    
      
      <a class="navbar-brand" href="../index.html">
        <img src="../_static/blazingNotebooks_logo.png" class="logo" alt="logo">
      </a>
      
    

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    
    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../arch.html">
  BlazingSQL Project Architecture
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../graph.html">
  Execution Engine
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api.html">
  API Documentation
 </a>
</li>

        
      </ul>

      <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              

<nav id="bd-toc-nav">
    
</nav>



<div class="tocsection editthispage">
    <a href="https://github.com/blazingdb/blazingsql/edit/feedback/docsrc/source/xml/program_listing_file_engine_src_execution_graph_logic_controllers_taskflow_executor.cpp.rst">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="program-listing-for-file-executor-cpp">
<span id="program-listing-file-engine-src-execution-graph-logic-controllers-taskflow-executor-cpp"></span><h1>Program Listing for File executor.cpp<a class="headerlink" href="#program-listing-for-file-executor-cpp" title="Permalink to this headline">¶</a></h1>
<p>↰ <a class="reference internal" href="file_engine_src_execution_graph_logic_controllers_taskflow_executor.cpp.html#file-engine-src-execution-graph-logic-controllers-taskflow-executor-cpp"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">engine/src/execution_graph/logic_controllers/taskflow/executor.cpp</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;executor.h&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">fmt</span><span class="o">::</span><span class="n">literals</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">ral</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">execution</span><span class="p">{</span>

<span class="kt">size_t</span> <span class="n">executor</span><span class="o">::</span><span class="n">add_task</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheData</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">inputs</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheMachine</span><span class="o">&gt;</span> <span class="n">output</span><span class="p">,</span>
    <span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">kernel</span> <span class="o">*</span> <span class="n">kernel</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">auto</span> <span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id_counter</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>

    <span class="n">kernel</span><span class="o">-&gt;</span><span class="n">add_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">);</span>

    <span class="k">auto</span> <span class="n">task_added</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">task</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span><span class="n">output</span><span class="p">,</span><span class="n">task_id</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">attempts_limit</span><span class="p">,</span> <span class="n">args</span>
    <span class="p">);</span>

    <span class="n">task_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task_added</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">task_id</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">executor</span><span class="o">::</span><span class="n">add_task</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheData</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">inputs</span><span class="p">,</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheMachine</span><span class="o">&gt;</span> <span class="n">output</span><span class="p">,</span>
        <span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">kernel</span> <span class="o">*</span> <span class="n">kernel</span><span class="p">,</span>
        <span class="kt">size_t</span> <span class="n">attempts</span><span class="p">,</span>
        <span class="kt">size_t</span> <span class="n">task_id</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">args</span><span class="p">){</span>

    <span class="k">auto</span> <span class="n">task_added</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">task</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span><span class="n">output</span><span class="p">,</span><span class="n">task_id</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">attempts_limit</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">attempts</span>
    <span class="p">);</span>
    <span class="n">task_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task_added</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">executor</span><span class="o">::</span><span class="n">add_task</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">task</span><span class="o">&gt;</span> <span class="n">task</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">task_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">task</span><span class="o">&gt;</span> <span class="n">executor</span><span class="o">::</span><span class="n">remove_task_from_back</span><span class="p">(){</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task_queue</span><span class="p">.</span><span class="n">pop_back</span><span class="p">());</span>
<span class="p">}</span>

<span class="n">task</span><span class="o">::</span><span class="n">task</span><span class="p">(</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheData</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">inputs</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheMachine</span><span class="o">&gt;</span> <span class="n">output</span><span class="p">,</span>
    <span class="kt">size_t</span> <span class="n">task_id</span><span class="p">,</span>
    <span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">kernel</span> <span class="o">*</span> <span class="n">kernel</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">attempts_limit</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">args</span><span class="p">,</span>
    <span class="kt">size_t</span> <span class="n">attempts</span><span class="p">)</span> <span class="o">:</span>
    <span class="n">inputs</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">inputs</span><span class="p">)),</span>
    <span class="n">output</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">task_id</span><span class="p">(</span><span class="n">task_id</span><span class="p">),</span>
    <span class="n">kernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">),</span><span class="n">attempts</span><span class="p">(</span><span class="n">attempts</span><span class="p">),</span>
    <span class="n">attempts_limit</span><span class="p">(</span><span class="n">attempts_limit</span><span class="p">),</span> <span class="n">args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">task_logger</span> <span class="o">=</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;task_logger&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">task</span><span class="o">::</span><span class="n">task_memory_needed</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">bytes_to_decache</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// space needed to deache inputs which are currently not in GPU</span>

    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span> <span class="nl">input</span> <span class="p">:</span> <span class="n">inputs</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheDataType</span><span class="o">::</span><span class="n">CPU</span> <span class="o">||</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheDataType</span><span class="o">::</span><span class="n">LOCAL_FILE</span><span class="p">){</span>
            <span class="n">bytes_to_decache</span> <span class="o">+=</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">sizeInBytes</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheDataType</span><span class="o">::</span><span class="n">IO_FILE</span><span class="p">){</span>
            <span class="c1">// TODO! Need to figure out what we want to do to try to estimate consumption for this</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">bytes_to_decache</span> <span class="o">+</span> <span class="n">kernel</span><span class="o">-&gt;</span><span class="n">estimate_output_bytes</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">+</span> <span class="n">kernel</span><span class="o">-&gt;</span><span class="n">estimate_operating_bytes</span><span class="p">(</span><span class="n">inputs</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">task</span><span class="o">::</span><span class="n">run</span><span class="p">(</span><span class="n">cudaStream_t</span> <span class="n">stream</span><span class="p">,</span> <span class="n">executor</span> <span class="o">*</span> <span class="n">executor</span><span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ral</span><span class="o">::</span><span class="n">frame</span><span class="o">::</span><span class="n">BlazingTable</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">input_gpu</span><span class="p">;</span>
    <span class="n">CodeTimer</span> <span class="n">decachingEventTimer</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">last_input_decached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// Decaching inputs</span>
    <span class="k">try</span><span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span> <span class="nl">input</span> <span class="p">:</span> <span class="n">inputs</span><span class="p">){</span>
                    <span class="c1">//if its in gpu this wont fail</span>
                    <span class="c1">//if its cpu and it fails the buffers arent deleted</span>
                    <span class="c1">//if its disk and fails the file isnt deleted</span>
                    <span class="c1">//so this should be safe</span>
                    <span class="n">last_input_decached</span><span class="o">++</span><span class="p">;</span>
                    <span class="n">input_gpu</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">decache</span><span class="p">()));</span>
            <span class="p">}</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="k">const</span> <span class="n">rmm</span><span class="o">::</span><span class="n">bad_alloc</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span> <span class="nl">input</span> <span class="p">:</span> <span class="n">inputs</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">last_input_decached</span> <span class="o">&amp;&amp;</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheDataType</span><span class="o">::</span><span class="n">GPU</span> <span class="p">){</span>
                <span class="c1">//this was a gpu cachedata so now its not valid</span>
                <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">GPUCacheData</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">set_data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">input_gpu</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
            <span class="p">}</span>
            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">spdlog</span><span class="o">::</span><span class="n">logger</span><span class="o">&gt;</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;batch_logger&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">){</span>
            <span class="n">logger</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;|||{info}|||||&quot;</span><span class="p">,</span>
                    <span class="s">&quot;info&quot;</span><span class="n">_a</span><span class="o">=</span><span class="s">&quot;ERROR of type rmm::bad_alloc in task::run. What: {}&quot;</span><span class="n">_format</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()));</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="o">-&gt;</span><span class="n">attempts</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">attempts</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">attempts_limit</span><span class="p">){</span>
            <span class="n">executor</span><span class="o">-&gt;</span><span class="n">add_task</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span> <span class="n">output</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">attempts</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">throw</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">){</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">spdlog</span><span class="o">::</span><span class="n">logger</span><span class="o">&gt;</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;batch_logger&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">){</span>
            <span class="n">logger</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;|||{info}|||||&quot;</span><span class="p">,</span>
                    <span class="s">&quot;info&quot;</span><span class="n">_a</span><span class="o">=</span><span class="s">&quot;ERROR in task::run. What: {}&quot;</span><span class="n">_format</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()));</span>
        <span class="p">}</span>

        <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">decaching_elapsed</span> <span class="o">=</span> <span class="n">decachingEventTimer</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">();</span>

    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">log_input_rows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">log_input_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">input_gpu</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">log_input_rows</span> <span class="o">+=</span> <span class="n">input_gpu</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">num_rows</span><span class="p">();</span>
        <span class="n">log_input_bytes</span> <span class="o">+=</span> <span class="n">input_gpu</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sizeInBytes</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">CodeTimer</span> <span class="n">executionEventTimer</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">task_result</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">-&gt;</span><span class="n">process</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">input_gpu</span><span class="p">),</span><span class="n">output</span><span class="p">,</span><span class="n">stream</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">task_logger</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">task_logger</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;{time_started}|{ral_id}|{query_id}|{kernel_id}|{duration_decaching}|{duration_execution}|{input_num_rows}|{input_num_bytes}&quot;</span><span class="p">,</span>
                        <span class="s">&quot;time_started&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">decachingEventTimer</span><span class="p">.</span><span class="n">start_time</span><span class="p">(),</span>
                        <span class="s">&quot;ral_id&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">kernel</span><span class="o">-&gt;</span><span class="n">get_context</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNodeIndex</span><span class="p">(</span><span class="n">ral</span><span class="o">::</span><span class="n">communication</span><span class="o">::</span><span class="n">CommunicationData</span><span class="o">::</span><span class="n">getInstance</span><span class="p">().</span><span class="n">getSelfNode</span><span class="p">()),</span>
                        <span class="s">&quot;query_id&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">kernel</span><span class="o">-&gt;</span><span class="n">get_context</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getContextToken</span><span class="p">(),</span>
                        <span class="s">&quot;kernel_id&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">kernel</span><span class="o">-&gt;</span><span class="n">get_id</span><span class="p">(),</span>
                        <span class="s">&quot;duration_decaching&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">decaching_elapsed</span><span class="p">,</span>
                        <span class="s">&quot;duration_execution&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">executionEventTimer</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">(),</span>
                        <span class="s">&quot;input_num_rows&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">log_input_rows</span><span class="p">,</span>
                        <span class="s">&quot;input_num_bytes&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">log_input_bytes</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">task_result</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">ral</span><span class="o">::</span><span class="n">execution</span><span class="o">::</span><span class="n">task_status</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">){</span>
        <span class="n">complete</span><span class="p">();</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">task_result</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">ral</span><span class="o">::</span><span class="n">execution</span><span class="o">::</span><span class="n">task_status</span><span class="o">::</span><span class="n">RETRY</span><span class="p">){</span>
        <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span> <span class="nl">input</span> <span class="p">:</span> <span class="n">inputs</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="n">input</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">){</span>
                <span class="k">if</span>  <span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheDataType</span><span class="o">::</span><span class="n">GPU</span><span class="p">){</span>
                    <span class="c1">//this was a gpu cachedata so now its not valid</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">task_result</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">task_result</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">task_result</span><span class="p">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">task_result</span><span class="p">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">is_valid</span><span class="p">()){</span>
                        <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">GPUCacheData</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">set_data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task_result</span><span class="p">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
                    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                        <span class="c1">//the input was lost and it was a gpu dataframe which is not recoverable</span>
                        <span class="k">throw</span> <span class="n">rmm</span><span class="o">::</span><span class="n">bad_alloc</span><span class="p">(</span><span class="n">task_result</span><span class="p">.</span><span class="n">what</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Input is null, cannot recover&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">attempts</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">attempts</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">attempts_limit</span><span class="p">){</span>
            <span class="n">executor</span><span class="o">-&gt;</span><span class="n">add_task</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span> <span class="n">output</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">attempts</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">throw</span> <span class="n">rmm</span><span class="o">::</span><span class="n">bad_alloc</span><span class="p">(</span><span class="s">&quot;Ran out of memory processing&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="n">task_result</span><span class="p">.</span><span class="n">what</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">task</span><span class="o">::</span><span class="n">complete</span><span class="p">(){</span>
    <span class="n">kernel</span><span class="o">-&gt;</span><span class="n">notify_complete</span><span class="p">(</span><span class="n">task_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">task</span><span class="o">::</span><span class="n">fail</span><span class="p">(){</span>
    <span class="n">kernel</span><span class="o">-&gt;</span><span class="n">notify_fail</span><span class="p">(</span><span class="n">task_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheData</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">task</span><span class="o">::</span><span class="n">release_inputs</span><span class="p">(){</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">task</span><span class="o">::</span><span class="n">set_inputs</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ral</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">CacheData</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">inputs</span><span class="p">){</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">inputs</span><span class="p">);</span>
<span class="p">}</span>



<span class="n">executor</span> <span class="o">*</span> <span class="n">executor</span><span class="o">::</span><span class="n">_instance</span><span class="p">;</span>

<span class="n">executor</span><span class="o">::</span><span class="n">executor</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_threads</span><span class="p">,</span> <span class="kt">double</span> <span class="n">processing_memory_limit_threshold</span><span class="p">)</span> <span class="o">:</span>
 <span class="n">pool</span><span class="p">(</span><span class="n">num_threads</span><span class="p">),</span> <span class="n">task_id_counter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blazing_device_memory_resource</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()),</span> <span class="n">task_queue</span><span class="p">(</span><span class="s">&quot;executor_task_queue&quot;</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">processing_memory_limit</span> <span class="o">=</span> <span class="n">resource</span><span class="o">-&gt;</span><span class="n">get_total_memory</span><span class="p">()</span> <span class="o">*</span> <span class="n">processing_memory_limit_threshold</span><span class="p">;</span>
     <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_threads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
         <span class="n">cudaStream_t</span> <span class="n">stream</span><span class="p">;</span>
         <span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">);</span>
         <span class="n">streams</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
     <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">executor</span><span class="o">::</span><span class="n">execute</span><span class="p">(){</span>
    <span class="k">while</span><span class="p">(</span><span class="n">shutdown</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="c1">//consider using get_all and calling in a loop.</span>
        <span class="k">auto</span> <span class="n">cur_task</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">task_queue</span><span class="p">.</span><span class="n">pop_or_wait</span><span class="p">();</span>
        <span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="n">push</span><span class="p">([</span><span class="o">&amp;</span><span class="n">cur_task</span><span class="p">,</span> <span class="k">this</span><span class="p">](</span><span class="kt">int</span> <span class="n">thread_id</span><span class="p">){</span>
            <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">memory_needed</span> <span class="o">=</span> <span class="n">cur_task</span><span class="o">-&gt;</span><span class="n">task_memory_needed</span><span class="p">();</span>

            <span class="c1">// Here we want to wait until we make sure we have enough memory to operate, or if there are no tasks currently running, then we want to go ahead and run</span>
            <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">memory_safety_mutex</span><span class="p">);</span>
            <span class="n">memory_safety_cv</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">,</span> <span class="n">memory_needed</span><span class="p">]</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">memory_needed</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">processing_memory_limit</span> <span class="o">-</span> <span class="n">resource</span><span class="o">-&gt;</span><span class="n">get_memory_used</span><span class="p">())){</span>
                    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">active_tasks_counter</span><span class="p">.</span><span class="n">load</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">spdlog</span><span class="o">::</span><span class="n">logger</span><span class="o">&gt;</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;batch_logger&quot;</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">){</span>
                        <span class="n">logger</span><span class="o">-&gt;</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;|||{info}|||||&quot;</span><span class="p">,</span>
                                <span class="s">&quot;info&quot;</span><span class="n">_a</span><span class="o">=</span><span class="s">&quot;WARNING: launching task even though over limit, because there are no tasks running. Memory used: {}&quot;</span><span class="n">_format</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">get_memory_used</span><span class="p">())));</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="p">});</span>

            <span class="n">active_tasks_counter</span><span class="o">++</span><span class="p">;</span>
            <span class="n">cur_task</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">thread_id</span><span class="p">],</span><span class="k">this</span><span class="p">);</span>
            <span class="n">active_tasks_counter</span><span class="o">--</span><span class="p">;</span>
            <span class="n">memory_safety_cv</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span>
        <span class="p">});</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="n">f</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(...)</span> <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">exception_holder_mutex</span><span class="p">);</span>
            <span class="n">exception_holder</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">current_exception</span><span class="p">());</span>
            <span class="n">cur_task</span><span class="o">-&gt;</span><span class="n">fail</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">exception_ptr</span> <span class="n">executor</span><span class="o">::</span><span class="n">last_exception</span><span class="p">(){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">exception_holder_mutex</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">exception_ptr</span> <span class="n">e</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exception_holder</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">exception_holder</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
        <span class="n">exception_holder</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">executor</span><span class="o">::</span><span class="n">has_exception</span><span class="p">(){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">exception_holder_mutex</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">!</span><span class="n">exception_holder</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span>
<span class="p">}</span>

<span class="p">}</span> <span class="c1">// namespace execution</span>
<span class="p">}</span> <span class="c1">// namespace ral</span>
</pre></div>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../_static/js/index.d8bbf5861d671d414e1a.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2020, BlazingDB, Inc..<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>